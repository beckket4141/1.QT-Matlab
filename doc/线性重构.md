function rho_r = reconstruct_density_matrix_nD(PnD, dimension)

  % 输入:

  % PnD - 测量得到的功率值数组，大小为 dimension^2

  % dimension - 系统的维度 n（2, 3, 4,...）

  % 输出:

  % rho_r - 重构的 n 维密度矩阵

  % 输入功率值

  p = PnD;  

  P_raw = p';

  

  % 对测量功率值进行归一化

  P = P_raw / sum(P_raw(1:dimension)); 

  % 生成投影算符

  [~, mu] = generate_projectors_and_operators(dimension);

  % 构建线性方程组 M

  M = zeros(dimension^2, dimension^2);

  for j = 1:dimension^2

​    mu_j = mu{j};

​    M(j, :) = reshape(mu_j, 1, []); % 将投影算符展开为行向量形式

  end

  % 求解密度矩阵的元素

  rho_vector = M \ P;

  % 将向量形式的密度矩阵转换为 n x n 矩阵

  rho_matrix = reshape(rho_vector, dimension, dimension);

  % 对整个矩阵取共轭

  rho_matrix = conj(rho_matrix);

  % 根据方法 xx 的值进行物理条件的调整

  xx = 0;  % 修改 xx 值，0 表示调用 makephysical 函数

  if xx == 1

​    rho_matrix = (rho_matrix + rho_matrix') / 2;

​    rho_matrix = rho_matrix / trace(rho_matrix);

  elseif xx == 0

​    rho_matrix = makephysical(rho_matrix);

  else

​    error('wrong xx.');

  end

  % 返回重构的密度矩阵

  rho_r = rho_matrix;

  % 输出重构的密度矩阵

  disp('重构的密度矩阵：');

  disp(rho_r);

end









function out = makephysical(rho)

  % function out = makephysical(rho)

  % 确保 rho 是正定的密度矩阵。

  % 通过删除负特征值的方式使其正定。

  

  % 计算矩阵 rho 的特征值分解

  [v, d] = eig(rho);

  

  % 将负特征值设为零

  d(find(d < 0)) = 0;

  

  % 归一化特征值矩阵，使其迹为1

  d = d / trace(d);

  

  % 使用特征向量矩阵 v 和处理后的特征值矩阵 d 重构密度矩阵

  rho = v * d / v;

  

  % 确保密度矩阵是 Hermitian 矩阵并且具有物理意义

  out = tril(rho, -1) + tril(rho, -1)' ...

​    \+ real(diag(diag(rho))) + eye(size(rho)) * 1e-6;

  

  % 详细解释:

  % 1. 特征值分解: [v, d] = eig(rho);

  %   - v 是特征向量矩阵，d 是包含特征值的对角矩阵。

  % 2. 删除负特征值: d(find(d < 0)) = 0;

  %   - 找到 d 中小于零的元素索引，并将这些元素设置为零，确保特征值非负。

  % 3. 归一化特征值矩阵: d = d / trace(d);

  %   - 计算 d 的迹并归一化，使密度矩阵的迹为1。

  % 4. 重构密度矩阵: rho = v * d / v;

  %   - 使用特征向量 v 和处理后的特征值 d 重新构造密度矩阵。

  % 5. 确保 Hermitian 性和数值稳定性:

  %   out = tril(rho, -1) + tril(rho, -1)' + real(diag(diag(rho))) + eye(size(rho)) * 1e-6;

  %   - tril(rho, -1) 提取 rho 的下三角部分（不包括对角线）。

  %   - tril(rho, -1)' 提取 rho 的下三角部分的共轭转置，使 rho 矩阵成为 Hermitian。

  %   - real(diag(diag(rho))) 确保对角元素是实数。

  %   - eye(size(rho)) * 1e-6 在对角线上加入一个非常小的数，确保数值稳定性。

end