function [fidelity_values, P_values] = Bell_state(rho_final, n, filename, target_row)
    % Bell 态保真度计算函数（支持 4, 9, 16 维度）
    % 输入：
    %   rho_final  - 最终重构的密度矩阵
    %   n          - 系统维度（支持 4, 9, 16）
    %   filename   - 指定的 Excel 文件路径
    %   target_row - Excel 中的目标行数
    % 输出：
    %   fidelity_values - 计算的保真度数组
    %   P_values        - 所有 Bell 态的测量功率值

    % 初始化保真度数组和功率数组
    fidelity_values = zeros(1, n); % 初始化保真度数组
    P_values = cell(n, 1); % 用于存储测量功率值

    % 根据系统维度选择系数和相位数组
    switch n
        case 4
            % 系数和相位数组（维度 4）
            coefficients = {
                [1, 0, 0, 0], [0, 0, 0, 0];
                [0, 1, 0, 0], [0, 0, 0, 0];
                [0, 0, 1, 0], [0, 0, 0, 0];
                [0, 0, 0, 1], [0, 0, 0, 0];
            };
        case 9
            % 系数和相位数组（维度 9）
            coefficients = {
                [1, 0, 0, 0, 1, 0, 0, 0, 1], [0, 0, 0, 0, 0, 0, 0, 0, 0];
                [1, 0, 0, 0, 1, 0, 0, 0, 1], [0, 0, 0, 0, 2/3, 0, 0, 0, 4/3];
                [1, 0, 0, 0, 1, 0, 0, 0, 1], [0, 0, 0, 0, 4/3, 0, 0, 0, 8/3];
                [0, 1, 0, 0, 0, 1, 1, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0];
                [0, 1, 0, 0, 0, 1, 1, 0, 0], [0, 0, 0, 0, 0, 2/3, 4/3, 0, 0];
                [0, 1, 0, 0, 0, 1, 1, 0, 0], [0, 0, 0, 0, 0, 4/3, 8/3, 0, 0];
                [0, 0, 1, 1, 0, 0, 0, 1, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0];
                [0, 0, 1, 1, 0, 0, 0, 1, 0], [0, 0, 0, 2/3, 0, 0, 0, 4/3, 0];
                [0, 0, 1, 1, 0, 0, 0, 1, 0], [0, 0, 0, 4/3, 0, 0, 0, 8/3, 0];
            };
        case 16
            % 系数和相位数组（维度 16）
            coefficients = {
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态00
                [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态01
                [0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态02
                [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态03
                [0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态10
                [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态11
                [0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态12
                [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态13
                [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态20
                [0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态21
                [0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态22
                [0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态23
                [0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态30
                [0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态31
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态32
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; % bell态33
            };
        otherwise
            error('Unsupported system dimension. Only 4, 9, and 16 are supported.');
    end

    % 遍历所有 Bell 态
    for i = 1:n
        % 提取当前 Bell 态的系数和相位
        a = coefficients{i, 1};
        b = coefficients{i, 2};
        
        % 调用理论测量函数计算预测密度矩阵和测量功率
        [r, P] = theoretical_measurement_powers_nD_fun(n, a, b);
        fidelity_values(i) = fidelity(r, rho_final); % 计算保真度
        
        % 保存当前 Bell 态的测量功率
        P_values{i} = P;
    end

    % 显示保真度数组
    disp('保真度数组:');
    disp(real(fidelity_values));
    
%     % 保存到 Excel 文件
%     if nargin > 2 % 如果提供了文件路径和行号
%         writematrix(fidelity_values, filename, 'Sheet', 1, 'Range', sprintf('A%d', target_row));
%         disp(['保真度值已存储到 Excel 文件: ', filename, ', 第 ', num2str(target_row), ' 行']);
%     end
  % 保存到当前文件夹的 Excel 文件
    if nargin > 2 % 如果提供了文件名和行号
        writematrix(fidelity_values, filename, 'Sheet', 1, 'Range', sprintf('A%d', target_row));
        disp(['保真度值已存储到当前文件夹中的 Excel 文件: ', filename, ', 第 ', num2str(target_row), ' 行']);
    end    

    % 将测量功率值 P 保存到工作区
    assignin('base', 'P_values', P_values);
end
