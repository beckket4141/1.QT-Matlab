# 最大似然量子层析的局部极值与秩亏解风险评估

## 1. 流程概览与关键约束
该仓库的最大似然层析例程采用 Cholesky 型参数化：首先把线性重构后的密度矩阵 \(\rho_r\) 转写为上三角矩阵参数 \(t\)，然后通过 \(\rho(t) = T(t)^{\dagger}T(t) / \mathrm{Tr}[T(t)^{\dagger}T(t)]\) 重建物理密度矩阵。【F:FindInitialT.m†L1-L29】【F:construct_density_matrix.m†L1-L35】目标函数以测量概率与理论概率的加权残差平方和为代价；理论概率由同一组投影算符与当前密度矩阵计算。【F:likelihood_function.m†L1-L49】整体优化由 `fmincon` 的 SQP 算法完成，未施加额外硬约束，只设定极高的迭代步数和函数评估上限，并使用线性重构所给的 `FindInitialT` 输出作为唯一初值。【F:reconstruct_density_matrix_nD_MLE.m†L13-L58】

这一组合保证了搜索过程始终在正半定、单位迹的可行域中进行，同时也埋下了局部极值和秩亏解同时出现的可能性。

## 2. 局部最优收敛风险的细化分析
### 2.1 参数化映射的高度非线性
密度矩阵由上三角矩阵 \(T\) 通过二次型再归一化得到，本质上是对自由参数的有理函数映射。【F:construct_density_matrix.m†L18-L35】在参数空间中，任何非平凡的相位或幅度扰动都会通过乘方与归一化耦合到所有矩阵元素，使得目标函数等高线呈现弯曲的山谷与鞍点。与凸优化不同，SQP 只能保证在局部满足一阶与二阶最优性条件，而无法排除陷入次优盆地的情形。

### 2.2 加权残差的非凸性
似然函数采用 \(\sum_k (p_k - p_k^{\mathrm{theory}})^2 / \sqrt{p_k + 1}\) 的经验权重结构。【F:likelihood_function.m†L26-L49】加权因子依赖于测量概率自身，因此目标函数对参数的二阶导数不仅包含理论概率的二阶项，还混入了 \(p_k\) 的反比权重；在概率极小或极大的测量通道上，这些权重会让 Hessian 矩阵出现条件数恶化，进一步加剧非凸形状与尖锐峡谷对局部法的影响。

### 2.3 初值与无界变量导致的搜索偏置
优化变量没有上下界，仅靠初值决定起始搜索域。【F:reconstruct_density_matrix_nD_MLE.m†L38-L49】当线性重构的结果因噪声或截断误差偏离真实态时，`FindInitialT` 会把这种偏差直接投射到参数空间。若某些对角元素极小或为零（见下一节），初始点就位于可行域的狭窄边缘，SQP 的近似二次模型在该区域通常呈拉长的谷地，极易被线性化误差所主导，从而沿着局部坡度停在次优点。

### 2.4 高迭代阈值与缺少多起点策略
虽然 `fmincon` 配置了极高的迭代与评估上限，以防止过早停机，但并未配套多起点或全局化策略，例如随机扰动初始点、模拟退火或全局优化工具箱。这意味着一旦初始点进入局部盆地，额外的迭代只是沿局部曲率调整步长，并不能跳出局部极值。

## 3. 秩亏解形成机制的逐层拆解
### 3.1 线性物理化阶段即贴近半正定锥边界
`makephysical` 在将线性反演结果投影到物理态时直接把所有负特征值截断为零，再归一化。【F:makephysical.m†L6-L20】这一步虽然确保了正半定，但也可能让某些原本很小的特征值直接消失，使初始 \(\rho_r\) 位于半正定锥的边界而非内部。

### 3.2 Cholesky 初值保留零特征
`FindInitialT` 通过对角元素开平方来生成上三角矩阵的主对角。如果输入密度矩阵的某个特征值为零，则对应的对角元素在初值中也为零，直接降低了 \(T\) 的秩。【F:FindInitialT.m†L14-L26】这意味着优化一开始就在秩亏流形上行进。

### 3.3 优化过程中缺乏“回拉”机制
在 MLE 优化阶段，构造密度矩阵时仅强制 \(T^{\dagger}T\) 正半定与单位迹，没有额外正则项鼓励非零特征值或惩罚小特征值。【F:construct_density_matrix.m†L18-L35】似然函数同样只关注测量残差，未对特征谱施加任何惩罚。【F:likelihood_function.m†L26-L49】因此，只要秩亏态能解释测量数据，`fmincon` 就没有理由向满秩区域移动。

### 3.4 纯态数据与噪声的共同作用
当真实态接近纯态时，最优解本就位于可行域边界；若测量噪声进一步把某些概率推到零附近，加权残差中的 \(\sqrt{p_k+1}\) 会降低相关通道的惩罚，优化器更倾向于把对应特征值压缩为零，从而稳定地收敛到秩亏解。

## 4. 现象对实验分析的潜在影响
1. **保真度评估波动**：秩亏解对与目标态的保真度更敏感，尤其在比较不同实验批次时，局部极值导致的细微差异可能被误解为系统误差。
2. **误差条估计偏差**：局部极值通常伴随非对称的置信区域，若后续误差分析假设近似正态，可能低估估计不确定度。
3. **参数扫描的连续性中断**：当实验参数连续变化时，局部极值的突然切换会让重构密度矩阵出现不连续跳跃，影响态制备调谐与反馈控制。

## 5. 初步改进思路
1. **多起点与随机扰动**：对 `FindInitialT` 的输出添加小幅随机噪声，或使用数个不同初值重复运行 `fmincon` 并比较 chi²，可显著降低陷入单一局部解的概率。
2. **惩罚项或软约束**：在似然函数中加入如 \(\lambda\,\mathrm{Tr}[(T^{\dagger}T - \epsilon I)^2_+]\) 的正则项，或在优化过程中对对角参数设置下界，缓和秩坍缩趋势。该修改需要相应调整 `construct_density_matrix` 或似然函数以兼容额外项。
3. **谱投影校正**：每次迭代后可选地对 \(\rho\) 做一次温和的谱平滑（例如把过小特征值抬升到阈值后再归一化），以免数值误差把态固定在秩亏子空间。
4. **全局/分层策略**：先运行粗精度或加入退火因子的全局搜索（粒子群、遗传算法等）寻找若干候选点，再用当前 SQP 配置做局部精修，可在保持精度的同时提升鲁棒性。
5. **噪声一致化权重**：把权重从 \(\sqrt{p_k+1}\) 改为更符合统计噪声的形式（如泊松噪声下的 \(1/\max(p_k,\epsilon)\)），并引入自适应阈值，避免零概率测量让残差缺乏约束。

## 6. 建议的诊断与监控指标
- **梯度范数与 Hessian 条件数**：从 `fmincon` 输出中记录终止时的梯度、拉格朗日乘子信息，识别是否因条件数恶化导致早停。
- **特征谱轨迹**：在迭代过程中保存密度矩阵特征值的演化，判断何时进入秩亏区域，可反向指导正则化强度。
- **多初值结果的可视化**：绘制不同初值下的 chi² 与保真度散点图，直接观测局部极值分布与分散程度。

## 7. 小结
当前实现的 Cholesky + SQP 框架在量子层析中属于主流做法，但其非凸性与缺乏秩正则的特性，使得局部极值和秩亏解成为必须面对的现实风险。通过多初值、谱正则与权重再设计等轻量改动，即可在保持现有代码结构的前提下提升收敛质量与物理解释的稳定性。
